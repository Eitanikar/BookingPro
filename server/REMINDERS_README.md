# 📧 מערכת תזכורות אוטומטיות להתורים

## תיאור
מערכת זו שולחת תזכורות דוא"ל אוטומטיות ללקוחות וספקים (בעלי עסק) **יום לפני** הפגישה המתוכננת.

## איך זה עובד?

### 1️⃣ בדיקה אוטומטית
- **זמן ביצוע**: כל יום בשעה **08:00** בוקר
- **לוגיקה**: המערכת בודקת את כל התורים שאמורים להיות מחר וטרם נשלחה עבורם תזכורת

### 2️⃣ שליחת תזכורות
עבור כל תור שמגיע מחר:
- **ללקוח**: דואר עם תזכורת על הפגישה (שעה, תאריך, שם העסק)
- **לספק/בעל עסק**: דואר עם תזכורת שיש לו תור מחר (שם הלקוח, שעה, תאריך)

### 3️⃣ ניהול רשומות
- הרשומה מאוחסנת בטבלה `appointment_reminders` כדי למנוע שליחה כפולה
- כל תזכורת מסומנת כ`sent` כאשר נשלחה בהצלחה

## קבצים שנוספו/שונו

```
server/
├── reminderService.js          ← NEW: קוד המתזכר
├── initDB.js                   ← MODIFIED: הוספת טבלה appointment_reminders
├── server.js                   ← MODIFIED: הפעלת המתזכר + endpoint לבדיקה
└── package.json                ← MODIFIED: הוספת node-cron
```

## משתנה סביבה

לא נדרשים משתנים סביבה חדשים! המערכת משתמשת בקיים:
- `EMAIL_USER` - דואר המערכת
- `EMAIL_PASS` - סיסמה/token של דואר

## בדיקת המערכת

### בדיקה ידנית
```bash
curl -X POST http://localhost:5000/api/test/send-reminders
```

תגובה מוצפנת:
```json
{
  "msg": "✅ בדיקת תזכורות התחילה"
}
```

### צפייה בלוגים
הפעלת השרת תציג הודעות כגון:
```
📅 הפעלת מתזכר התורים...
✅ מתזכר התורים מפעיל (בדיקה יומית בשעה 08:00)

[בזמן ביצוע בדיקה]
⏱️  התחלת בדיקת תזכורות (08:00)
🔍 בודק התורים שמגיעים מחר...
📨 נמצאו X התורים שמגיעים מחר
✅ תזכורת נשלחה ללקוח: user@email.com (תור מס' 123)
✅ תזכורת נשלחה לספק: provider@email.com (תור מס' 123)
```

## עיצוב הדואר

### דואר ללקוח 👤
```
🔔 תזכורת: התור שלך ל-[שם העסק] מחר
-------
📅 תאריך: [תאריך עברי]
⏰ שעה: [שעה]
🏢 עסק: [שם העסק]
⚠️ בבקשה, הגיע בזמן!
```

### דואר לספק 👨‍💼
```
📌 תזכורת: יש לך תור מחר בשעה [שעה]
-------
👤 לקוח: [שם הלקוח]
📅 תאריך: [תאריך עברי]
⏰ שעה: [שעה]
```

## טבלה חדשה: `appointment_reminders`

```sql
CREATE TABLE appointment_reminders (
    id SERIAL PRIMARY KEY,
    appointment_id INTEGER REFERENCES appointments(id),
    client_email VARCHAR(100),
    provider_email VARCHAR(100),
    reminder_type VARCHAR(50),     -- 'day_before', 'day_of', etc.
    sent_at TIMESTAMP,
    status VARCHAR(20)             -- 'sent', 'failed'
);
```

## הרחבות עתידיות

ניתן בקלות להוסיף:
- ✅ תזכורות ביום התור (לא רק יום לפני)
- ✅ SMS reminders
- ✅ התראות בתוך האפליקציה (push notifications)
- ✅ הודעות WhatsApp
- ✅ שליחה של פרטי התור בדואר (כתובת, טלפון וכו')

## הערות חשובות

1. **Timezone**: המערכת עכשיו מזהה "מחר" בהתאם לשעון ישראלי
2. **הודעות לא שלוחות**: אם יש שגיאה בשליחה, היא לא מומנעת וההתור מישמר
3. **דואר חייב לעבוד**: וודא שהמשתנים `EMAIL_USER` ו`EMAIL_PASS` בקובץ `.env` תקינים
